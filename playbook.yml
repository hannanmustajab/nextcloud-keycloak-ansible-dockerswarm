---
- name: Install/Update prerequisites.
  hosts: all
  become: true
  roles:
    - role: update

- name: Common part of the playbook for both nodes
  hosts: all
  become: true
  roles:
    - nfs
    - docker
    - logging_common
    - docker_swarm

- name: Setup local docker registry for custom images
  hosts: node1
  become: true
  roles:
    - role: registry

- name: Login in local docker registry with "VCC" user
  hosts: all
  become: true
  tasks:
    - name: Login
      community.docker.docker_login:
        username: vcc
        password: vcc
        registry_url: http://127.0.0.1:5000
      register: docker_registry_login
      # until: docker_registry_login is success
      # retries: 300
      delay: 1


- name: Database Services
  hosts: node1
  become: true
  roles:
    - role: database


- name: Keycloak Services
  hosts: node1
  become: true
  roles:
    - role: keycloak


- name: Nextcloud Services
  hosts: node1
  become: true
  roles:
    - role: nextcloud


- name: Traefik Services
  hosts: node1
  become: true
  roles:
    - role: traefik


- name: Logging services part of the playbook for both nodes
  hosts: node1
  become: true
  roles:
    - logging

- name: Grafana services part of the playbook
  hosts: node1
  become: true
  roles:
    - monitoring
